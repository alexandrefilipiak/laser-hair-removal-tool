---
phase: 04-not-found-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/equipment.ts
  - src/hooks/useLooseSearch.ts
autonomous: true

must_haves:
  truths:
    - "getRelatedByManufacturer returns machines from same manufacturer excluding current"
    - "getAllEquipment exposes all entries for filtering"
    - "useLooseSearch returns partial matches with threshold 0.5"
  artifacts:
    - path: "src/lib/equipment.ts"
      provides: "getRelatedByManufacturer and getAllEquipment functions"
      exports: ["getRelatedByManufacturer", "getAllEquipment"]
    - path: "src/hooks/useLooseSearch.ts"
      provides: "Loose fuzzy search hook for partial matches"
      exports: ["useLooseSearch"]
  key_links:
    - from: "src/hooks/useLooseSearch.ts"
      to: "Fuse.js"
      via: "memoized Fuse instance with threshold 0.5"
      pattern: "threshold:\\s*0\\.5"
    - from: "src/lib/equipment.ts"
      to: "entries array"
      via: "filter by manufacturer field"
      pattern: "manufacturer.*===.*manufacturer"
---

<objective>
Add data utilities and loose search hook for "Not Found" suggestions

Purpose: Enable partial match suggestions ("Did you mean?") and manufacturer-based related machines
Output: Two new exports in equipment.ts + new useLooseSearch hook
</objective>

<execution_context>
@C:/Users/alexa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/alexa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-not-found-flow/04-RESEARCH.md

# Existing implementation to extend
@src/lib/equipment.ts
@src/hooks/useSearch.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getAllEquipment and getRelatedByManufacturer to equipment.ts</name>
  <files>src/lib/equipment.ts</files>
  <action>
Add two new exported functions to equipment.ts:

1. `getAllEquipment(): EquipmentEntry[]`
   - Simply returns the `entries` array
   - Enables external modules to filter equipment data

2. `getRelatedByManufacturer(manufacturer: string, excludeSlug?: string, limit?: number): MachineEntry[]`
   - Filter entries to only machines (use isMachine type guard)
   - Filter by manufacturer (case-insensitive comparison)
   - Exclude the current machine by slug if provided
   - Limit results (default 3)
   - Return MachineEntry[] array

Implementation notes:
- Add functions after existing Lookup Functions section
- Use lowercase comparison for manufacturer: `m.manufacturer.toLowerCase() === manufacturer.toLowerCase()`
- Document both functions with JSDoc matching existing code style
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Import check: Create a quick test import in another file or use ts-node to verify exports work
  </verify>
  <done>
Both functions exported and callable. getRelatedByManufacturer("Candela", "gentlemax-pro") returns other Candela machines.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useLooseSearch hook with threshold 0.5</name>
  <files>src/hooks/useLooseSearch.ts</files>
  <action>
Create new hook file `src/hooks/useLooseSearch.ts`:

1. Copy the structure from useSearch.ts as a starting point
2. Change threshold from 0.3 to 0.5 (higher = more permissive for partial matches)
3. Keep all other Fuse.js options the same:
   - Same keys with weights (name: 2, aliases: 1.5, manufacturer: 1, slug: 0.5)
   - ignoreLocation: true
   - includeScore: true
   - includeMatches: true
   - minMatchCharLength: 2
   - shouldSort: true
   - findAllMatches: false
4. Limit results to 5 (fewer than strict search's 8, since these are suggestions)
5. Add comment explaining: `// Loose threshold (0.5) for "Did you mean?" suggestions when strict search (0.3) returns nothing`

Export signature:
```typescript
export function useLooseSearch(
  equipment: EquipmentEntry[],
  query: string
): FuseResult<EquipmentEntry>[]
```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
useLooseSearch hook exists with threshold 0.5 and returns up to 5 partial matches.
  </done>
</task>

</tasks>

<verification>
1. Both files exist and TypeScript compiles without errors
2. equipment.ts exports: getRelatedByManufacturer, getAllEquipment
3. useLooseSearch.ts exports: useLooseSearch
4. Dev server starts without errors: `npm run dev`
</verification>

<success_criteria>
- getAllEquipment() returns all ~38 equipment entries
- getRelatedByManufacturer("Candela") returns Candela machines
- getRelatedByManufacturer("Candela", "gentlemax-pro") excludes GentleMax Pro from results
- useLooseSearch returns partial matches that useSearch (threshold 0.3) would not return
</success_criteria>

<output>
After completion, create `.planning/phases/04-not-found-flow/04-01-SUMMARY.md`
</output>
