---
phase: 04-not-found-flow
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/NotFoundSuggestions.tsx
  - src/components/SearchBar.tsx
  - src/app/is-it-a-real-laser/[slug]/not-found.tsx
autonomous: true

must_haves:
  truths:
    - "User typing unknown equipment sees 'Did you mean?' partial match suggestions"
    - "User sees related machines from same manufacturer when available"
    - "Clicking suggestion navigates to machine page"
    - "Not-found page shows related machines when slug contains known manufacturer"
  artifacts:
    - path: "src/components/NotFoundSuggestions.tsx"
      provides: "Did you mean? and related machines UI"
      min_lines: 40
    - path: "src/components/SearchBar.tsx"
      provides: "Updated empty state with NotFoundSuggestions"
      contains: "NotFoundSuggestions"
    - path: "src/app/is-it-a-real-laser/[slug]/not-found.tsx"
      provides: "Enhanced 404 with related machines"
      contains: "getRelatedByManufacturer"
  key_links:
    - from: "src/components/SearchBar.tsx"
      to: "src/components/NotFoundSuggestions.tsx"
      via: "component import and render in empty state"
      pattern: "NotFoundSuggestions"
    - from: "src/components/NotFoundSuggestions.tsx"
      to: "src/hooks/useLooseSearch.ts"
      via: "hook call for partial matches"
      pattern: "useLooseSearch"
    - from: "src/app/is-it-a-real-laser/[slug]/not-found.tsx"
      to: "src/lib/equipment.ts"
      via: "getRelatedByManufacturer call"
      pattern: "getRelatedByManufacturer"
---

<objective>
Integrate not-found suggestions into SearchBar and 404 page

Purpose: Transform dead-end "no results" into helpful discovery opportunity
Output: Working suggestions UI in both search empty state and 404 page
</objective>

<execution_context>
@C:/Users/alexa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/alexa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-not-found-flow/04-RESEARCH.md
@.planning/phases/04-not-found-flow/04-01-SUMMARY.md

# Files to create/modify
@src/components/SearchBar.tsx
@src/app/is-it-a-real-laser/[slug]/not-found.tsx

# Related components for style reference
@src/components/SearchResultItem.tsx
@src/components/ClassificationBadge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NotFoundSuggestions component</name>
  <files>src/components/NotFoundSuggestions.tsx</files>
  <action>
Create new Client Component `src/components/NotFoundSuggestions.tsx`:

```typescript
'use client';
```

Props interface:
```typescript
interface NotFoundSuggestionsProps {
  query: string;                    // User's search query
  equipment: EquipmentEntry[];      // Full equipment list for loose search
  onSelect?: (slug: string) => void; // Optional callback when suggestion clicked
}
```

Component logic:
1. Call useLooseSearch(equipment, query) to get partial matches
2. Optionally detect manufacturer in query:
   - Use simple check: does query contain a known manufacturer name?
   - Known manufacturers: ["Candela", "Cynosure", "Lumenis", "Alma", "Cutera", "Quanta", "InMode", "Lutronic"]
   - If found, call getRelatedByManufacturer(manufacturer, undefined, 3)
3. Deduplicate: filter out related machines that are already in partial matches (compare slugs)

Render structure:
```tsx
<div className="text-left">
  {/* Partial matches - "Did you mean?" */}
  {partialMatches.length > 0 && (
    <div className="mb-4">
      <p className="text-sm font-medium text-gray-700 mb-2">Did you mean?</p>
      <ul className="space-y-1">
        {partialMatches.slice(0, 3).map(result => (
          <li key={result.item.slug}>
            <Link to machine page with name and manufacturer display
          </li>
        ))}
      </ul>
    </div>
  )}

  {/* Related machines by manufacturer */}
  {relatedMachines.length > 0 && (
    <div className="mb-4">
      <p className="text-sm font-medium text-gray-700 mb-2">
        Related {detectedManufacturer} machines:
      </p>
      <ul className="space-y-1">
        {relatedMachines.map(machine => (
          <li key={machine.slug}>
            <Link to machine page>
          </li>
        ))}
      </ul>
    </div>
  )}

  {/* Always show fallback */}
  <Link href="/is-it-a-real-laser" className="...">
    Browse all equipment
  </Link>
</div>
```

Styling:
- Match existing dropdown styles (rounded-xl, shadow-lg, bg-white)
- Links: text-blue-600 hover:text-blue-800 font-medium
- Machine display: name in bold, manufacturer in gray text
- Use existing ClassificationBadge for machine results

ARIA accessibility:
- Add `role="status" aria-live="polite"` to announce suggestions to screen readers
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
NotFoundSuggestions component renders "Did you mean?" with partial matches and related machines when applicable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate NotFoundSuggestions into SearchBar</name>
  <files>src/components/SearchBar.tsx</files>
  <action>
Modify SearchBar.tsx to replace the simple empty state with NotFoundSuggestions:

1. Add import:
   ```typescript
   import { NotFoundSuggestions } from './NotFoundSuggestions';
   ```

2. Replace the empty state section (lines 205-218) that currently shows:
   ```tsx
   {showEmptyState && (
     <div className="...">
       <p>No equipment found for "{debouncedQuery}"</p>
       <a href="/is-it-a-real-laser">Browse all equipment</a>
     </div>
   )}
   ```

   With:
   ```tsx
   {showEmptyState && (
     <div className="absolute z-50 w-full mt-2 bg-white border border-gray-200 rounded-xl shadow-lg p-6">
       <p className="text-gray-600 mb-4">
         No exact match for &quot;{debouncedQuery}&quot;
       </p>
       <NotFoundSuggestions
         query={debouncedQuery}
         equipment={equipment}
         onSelect={(slug) => {
           router.push(`/is-it-a-real-laser/${slug}`);
           setIsOpen(false);
           setQuery('');
         }}
       />
     </div>
   )}
   ```

3. The onSelect callback handles navigation, closes dropdown, and clears query (same as Enter key behavior).
  </action>
  <verify>
Dev server running: `npm run dev`
Manual test: Go to localhost:3000, type a query that has no exact match but partial matches exist
  </verify>
  <done>
SearchBar shows "Did you mean?" suggestions when no exact matches found instead of simple "No equipment found" message.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add related machines to not-found page</name>
  <files>src/app/is-it-a-real-laser/[slug]/not-found.tsx</files>
  <action>
Enhance the equipment not-found page with related machines:

1. This is a Server Component, so we can call getRelatedByManufacturer directly (no hooks).

2. Problem: We don't have access to the actual slug in not-found.tsx (Next.js limitation).
   Solution: Since we can't access the slug, we'll add a "popular machines" section instead of slug-based related machines.

   Alternative approach that DOES work:
   - Create a Client Component wrapper that reads window.location.pathname
   - Parse manufacturer from the slug and call getRelatedByManufacturer
   - BUT this causes hydration mismatch

   Best approach for Server Component:
   - Add a static "Browse popular equipment" section showing 3-4 diverse machines
   - Use getAllEquipment().filter(isMachine).slice(0, 4) to get top entries
   - This provides helpful suggestions without needing the slug

3. Add imports:
   ```typescript
   import { getAllEquipment, isMachine } from '@/lib/equipment';
   ```

4. At top of component, get suggestions:
   ```typescript
   const allEquipment = getAllEquipment();
   const machines = allEquipment.filter(isMachine);
   // Get a diverse sample - first 4 machines (they're sorted by manufacturer in JSON)
   const suggestions = machines.slice(0, 4);
   ```

5. Add suggestions section after the blue info box but before the search link:
   ```tsx
   {suggestions.length > 0 && (
     <div className="mt-6">
       <p className="text-sm font-medium text-gray-700 mb-3">
         Browse popular equipment:
       </p>
       <ul className="space-y-2">
         {suggestions.map((machine) => (
           <li key={machine.slug}>
             <Link
               href={`/is-it-a-real-laser/${machine.slug}`}
               className="text-blue-600 hover:text-blue-800 font-medium"
             >
               {machine.name}
               <span className="text-gray-500 font-normal"> by {machine.manufacturer}</span>
             </Link>
           </li>
         ))}
       </ul>
     </div>
   )}
   ```

6. Keep the existing "Search Equipment" button at the bottom.
  </action>
  <verify>
Navigate to a non-existent equipment page: localhost:3000/is-it-a-real-laser/fake-machine-xyz
Should see the not-found page with popular equipment suggestions
  </verify>
  <done>
Not-found page displays helpful machine suggestions alongside existing "ask your clinic" messaging.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Dev server starts: `npm run dev`
3. Search for non-existent equipment - see "Did you mean?" suggestions
4. Search for "Candela xyz" - see related Candela machines
5. Navigate to /is-it-a-real-laser/fake-machine - see popular equipment suggestions
6. Click any suggestion - navigates to machine page
</verification>

<success_criteria>
- Typing "gentlemax xyz" in search shows "Did you mean? GentleMax Pro" (partial match)
- Typing "Candela unknown" shows related Candela machines section
- Clicking suggestion navigates to machine page and clears search
- 404 page shows browseable machine suggestions
- All suggestions link correctly to /is-it-a-real-laser/[slug] pages
</success_criteria>

<output>
After completion, create `.planning/phases/04-not-found-flow/04-02-SUMMARY.md`
</output>
