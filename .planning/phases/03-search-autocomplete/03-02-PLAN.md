---
phase: 03-search-autocomplete
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/SearchBar.tsx
  - src/components/SearchResultItem.tsx
  - src/components/HighlightMatch.tsx
  - src/app/page.tsx
autonomous: true

must_haves:
  truths:
    - "Main tool page has prominent search bar that responds to user input"
    - "Autocomplete suggestions appear as user types within 200ms"
    - "Results display classification layers in clear visual hierarchy"
    - "Keyboard navigation works (arrow keys, Enter, Escape)"
    - "Search results link to equipment detail pages"
  artifacts:
    - path: "src/components/SearchBar.tsx"
      provides: "Main search input with ARIA combobox and autocomplete dropdown"
      exports: ["SearchBar"]
    - path: "src/components/SearchResultItem.tsx"
      provides: "Individual result row with highlighted name and classification badge"
      exports: ["SearchResultItem"]
    - path: "src/components/HighlightMatch.tsx"
      provides: "Text with matched characters highlighted"
      exports: ["HighlightMatch"]
    - path: "src/app/page.tsx"
      provides: "Homepage with SearchBar component and equipment data"
      min_lines: 20
  key_links:
    - from: "src/components/SearchBar.tsx"
      to: "src/hooks/useSearch.ts"
      via: "import and call useSearch hook"
      pattern: "useSearch"
    - from: "src/components/SearchBar.tsx"
      to: "src/hooks/useDebounce.ts"
      via: "import and call useDebounce hook"
      pattern: "useDebounce"
    - from: "src/components/SearchResultItem.tsx"
      to: "/is-it-a-real-laser/[slug]"
      via: "Next.js Link component"
      pattern: "href=.*is-it-a-real-laser"
    - from: "src/app/page.tsx"
      to: "src/components/SearchBar.tsx"
      via: "Server Component passes equipment data as prop"
      pattern: "<SearchBar.*equipment="
---

<objective>
Create the search UI components and integrate into the homepage.

Purpose: Build an accessible, keyboard-navigable autocomplete search bar with instant results showing classification badges, completing the user-facing search experience.

Output: Prominent search bar on homepage with real-time fuzzy search, highlighted matches, and classification badges in results.
</objective>

<execution_context>
@C:/Users/alexa/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/alexa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-search-autocomplete/03-RESEARCH.md
@.planning/phases/03-search-autocomplete/03-01-SUMMARY.md

@src/lib/equipment.ts
@src/hooks/useDebounce.ts
@src/hooks/useSearch.ts
@src/components/ClassificationBadge.tsx
@src/app/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HighlightMatch and SearchResultItem components</name>
  <files>
    src/components/HighlightMatch.tsx
    src/components/SearchResultItem.tsx
  </files>
  <action>
**Create `src/components/HighlightMatch.tsx`:**
- Mark with `'use client'` directive
- Import FuseResultMatch type from 'fuse.js'
- Accept props: text (string), matches (readonly FuseResultMatch[] | undefined), fieldKey (string)
- Find matches for the specific fieldKey
- If no matches, return plain span with text
- Build segments by iterating through match indices:
  - Non-matched text before each match
  - Matched text wrapped in `<mark className="bg-yellow-200 rounded">`
  - Remaining text after last match
- Return span containing all segments

**Create `src/components/SearchResultItem.tsx`:**
- Mark with `'use client'` directive
- Import Link from 'next/link'
- Import FuseResult type from 'fuse.js'
- Import EquipmentEntry, MachineEntry, isMachine from '@/lib/equipment'
- Import ClassificationBadge from './ClassificationBadge'
- Import HighlightMatch from './HighlightMatch'
- Accept props: result (FuseResult<EquipmentEntry>), isActive (boolean), index (number)
- Render li element with:
  - id={`result-${index}`} for ARIA activedescendant
  - role="option"
  - aria-selected={isActive}
  - Conditional styling: `bg-blue-50` when active, `hover:bg-gray-50` otherwise
  - Link to `/is-it-a-real-laser/${item.slug}`
  - Flex layout with name highlighted via HighlightMatch
  - If machine: show manufacturer (also highlighted) as secondary text
  - ClassificationBadge on the right side
    - For machines: pass technologyType={item.technologyType}
    - For technology terms: pass isRealLaser={item.isRealLaser}
  </action>
  <verify>
1. Both files exist: src/components/HighlightMatch.tsx, src/components/SearchResultItem.tsx
2. TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
HighlightMatch renders text with yellow-highlighted match segments. SearchResultItem renders result row with name, optional manufacturer, and classification badge.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SearchBar component with ARIA combobox</name>
  <files>src/components/SearchBar.tsx</files>
  <action>
Create `src/components/SearchBar.tsx` - full-featured accessible autocomplete:
- Mark with `'use client'` directive
- Import useState, useRef, useId, useEffect from 'react'
- Import { useRouter } from 'next/navigation'
- Import useSearch from '@/hooks/useSearch'
- Import useDebounce from '@/hooks/useDebounce'
- Import EquipmentEntry from '@/lib/equipment'
- Import SearchResultItem from './SearchResultItem'

**Props interface:**
```typescript
interface SearchBarProps {
  equipment: EquipmentEntry[];
}
```

**State:**
- query: string (controlled input)
- isOpen: boolean (dropdown visibility)
- activeIndex: number (keyboard navigation, -1 when none)
- containerRef: useRef for click-outside detection
- inputRef: useRef for input element
- listboxId: useId() for ARIA

**Hooks:**
- debouncedQuery = useDebounce(query, 150)
- results = useSearch(equipment, debouncedQuery)
- router = useRouter()

**Keyboard handler (handleKeyDown):**
- ArrowDown: increment activeIndex (wrap to 0)
- ArrowUp: decrement activeIndex (wrap to length-1)
- Enter: if activeIndex >= 0, navigate to result and close
- Escape: close dropdown, reset activeIndex to -1
- Home: set activeIndex to 0
- End: set activeIndex to results.length - 1

**Click outside effect:**
- useEffect with mousedown listener on document
- If click target not inside containerRef, close dropdown

**Open/close logic:**
- Open when: input focused AND query has content
- Close when: Escape pressed OR click outside OR result selected

**Render:**
- Container div with ref={containerRef} and relative positioning
- Search icon (magnifying glass SVG) positioned absolute left
- Input with:
  - type="text"
  - role="combobox"
  - aria-expanded={isOpen && results.length > 0}
  - aria-controls={listboxId}
  - aria-autocomplete="list"
  - aria-activedescendant={activeIndex >= 0 ? `result-${activeIndex}` : undefined}
  - value={query}
  - onChange={(e) => setQuery(e.target.value)}
  - onFocus={() => query.trim() && setIsOpen(true)}
  - onKeyDown={handleKeyDown}
  - placeholder="Search equipment by name or brand..."
  - Prominent styling: large text, rounded, shadow, focus ring
- Conditional dropdown (isOpen && results.length > 0):
  - ul with id={listboxId}, role="listbox"
  - Positioned absolute, full-width, shadow, max-height with overflow-auto
  - Map results to SearchResultItem
- Empty state (isOpen && debouncedQuery && results.length === 0):
  - Show "No equipment found" message with browse all link
  </action>
  <verify>
1. File exists: src/components/SearchBar.tsx
2. TypeScript compiles: `npx tsc --noEmit`
3. Component exports SearchBar function
  </verify>
  <done>
SearchBar component with ARIA combobox pattern, keyboard navigation (arrow keys, Enter, Escape, Home, End), click-outside to close, 150ms debounce, and results dropdown with visual hierarchy.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate SearchBar into homepage</name>
  <files>src/app/page.tsx</files>
  <action>
Update `src/app/page.tsx` to add the search bar:
- Keep as Server Component (no 'use client') - only import equipment data here
- Import SearchBar from '@/components/SearchBar'
- Import equipmentData from '@/data/equipment.json'
- Import EquipmentEntry type from '@/lib/equipment'
- Cast equipmentData as EquipmentEntry[]
- Update layout:
  - Keep existing title "Laser Hair Removal Equipment Checker"
  - Keep existing description paragraph
  - Add SearchBar component with equipment={equipment} prop
  - Remove "Coming soon" text (search is now available)
  - Center the search bar prominently below the title
  - Add padding/margin for visual prominence

The data flow is: Server Component imports JSON at build time -> passes as prop to Client Component SearchBar -> SearchBar uses useSearch hook with the data.
  </action>
  <verify>
1. Build succeeds: `npm run build`
2. Dev server starts: `npm run dev` (verify manually or check port)
3. Homepage shows search bar
4. Typing in search shows results
  </verify>
  <done>
Homepage displays prominent search bar. Typing shows instant fuzzy-matched results with classification badges. Clicking result navigates to equipment detail page.
  </done>
</task>

</tasks>

<verification>
Overall phase 03-02 verification:
1. `npm run build` completes successfully (static export)
2. All component files exist in src/components/
3. Homepage (src/app/page.tsx) imports and renders SearchBar
4. Manual testing: search for "gentle" returns GentleMax variants
</verification>

<success_criteria>
- SearchBar component renders on homepage with prominent styling
- Typing triggers debounced search (150ms delay)
- Results appear within 200ms of debounce completion
- Results show equipment name, manufacturer (for machines), and classification badge
- Keyboard navigation works (ArrowUp/Down, Enter to select, Escape to close)
- Clicking result navigates to /is-it-a-real-laser/[slug]
- Click outside closes dropdown
- Empty query shows no results
- ARIA attributes present for accessibility
</success_criteria>

<output>
After completion, create `.planning/phases/03-search-autocomplete/03-02-SUMMARY.md`
</output>
